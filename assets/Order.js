import{u as L,D as A,r,k as E,q as U,c as d,b as a,m as i,e as h,d as c,t as s,F as q,y as F,l as I,f as O,h as H,w as Q,j as P,o as n,v as G,E as J}from"./index.js";import{e as K,f as X,h as Y,i as Z,j as x}from"./user.js";import{_ as aa}from"./_plugin-vue_export-helper.js";import{C as ea}from"./credit-card.js";import{c as N}from"./createLucideIcon.js";import{R}from"./refresh-cw.js";import{W as sa}from"./wallet.js";/**
 * @license lucide-vue-next v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ta=N("info",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]]);/**
 * @license lucide-vue-next v0.562.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const oa=N("tag",[["path",{d:"M12.586 2.586A2 2 0 0 0 11.172 2H4a2 2 0 0 0-2 2v7.172a2 2 0 0 0 .586 1.414l8.704 8.704a2.426 2.426 0 0 0 3.42 0l6.58-6.58a2.426 2.426 0 0 0 0-3.42z",key:"vktsd0"}],["circle",{cx:"7.5",cy:"7.5",r:".5",fill:"currentColor",key:"kqv944"}]]),na={class:"dark-tech-order animate-fade-in"},da={class:"page-header"},la={class:"header-icon"},ra={key:0,class:"order-container"},ia={class:"order-main"},ca={class:"order-card glass-card"},ua={class:"card-header"},_a={class:"trade-no"},ha={class:"order-items"},pa={class:"order-item"},va={class:"item-info"},ma={class:"item-name"},ya={class:"item-period"},fa={class:"item-price"},ba={key:0,class:"order-coupon"},ka={class:"coupon-info"},ga={class:"coupon-amount"},$a={class:"order-total"},Ca={class:"total-amount"},wa={class:"payment-card glass-card"},za={class:"card-header"},Ma={class:"payment-methods"},Pa=["onClick"],Sa={class:"method-icon"},Ta=["src"],qa={class:"method-info"},Fa={class:"method-name"},Ia={key:0,class:"method-fee"},Oa={class:"payment-footer"},Ra=["disabled"],Na={key:1},Wa={key:2},Ba=["disabled"],Da={class:"order-sidebar"},Va={class:"tips-card glass-card"},ja={class:"card-header"},La={class:"tips-list"},Aa={key:1,class:"loading-state"},Ea={key:2,class:"error-state"},Ua={class:"pay-modal-content"},Ha={class:"qr-container"},Qa={key:0,class:"qr-code-box"},Ga={class:"qr-code"},Ja={key:0,class:"pay-link-box mt-4"},Ka={class:"mt-2 text-xs text-secondary"},Xa=["href"],Ya={key:1,class:"pay-link-box"},Za=["href"],xa={class:"pay-status"},ae={__name:"Order",setup(ee){const W=A(),b=H(),{t:y,tm:se}=L(),u=W.query.trade_no,f=r(!0),p=r(!1),l=r(null),k=r([]),v=r(null),w=r(""),g=r(!1),_=r({type:0,data:""}),z=r(!1);let $=null;const B=e=>y(`dashboard.plans.cycles.${e}`);E(async()=>{var e,t;if(!u){f.value=!1,w.value=y("dashboard.order.invalid");return}try{const[m,C]=await Promise.all([K({trade_no:u}),X()]);m.data&&(l.value=m.data),C.data&&(k.value=C.data,k.value.length>0&&(v.value=k.value[0].id))}catch(m){w.value=((t=(e=m.response)==null?void 0:e.data)==null?void 0:t.message)||"加载订单失败"}finally{f.value=!1}});const D=async()=>{var e;if(v.value){p.value=!0;try{const t=await Y({trade_no:u,method:v.value});if(t.type===-1){P.success(y("dashboard.order.paySuccess")),b.push({name:"PaymentSuccess",query:{trade_no:u,plan_name:(e=l.value.plan)==null?void 0:e.name,amount:l.value.total_amount}});return}if(t.type===0||t.data&&(t.data.startsWith("http://")||t.data.startsWith("https://"))){window.location.href=t.data;return}_.value={type:t.type,data:t.data},g.value=!0,V()}catch{}finally{p.value=!1}}},V=()=>{z.value=!0,$=setInterval(async()=>{var e;try{const t=await x({trade_no:u});(t.data===1||t.data===3)&&(M(),g.value=!1,P.success(y("dashboard.order.paySuccess")),b.push({name:"PaymentSuccess",query:{trade_no:u,plan_name:(e=l.value.plan)==null?void 0:e.name,amount:l.value.total_amount}}))}catch{}},3e3)},M=()=>{$&&(clearInterval($),$=null),z.value=!1},j=async()=>{try{await Z({trade_no:u}),P.success(y("dashboard.orders.cancelledMessage")),b.push("/plans")}catch{}};return U(()=>{M()}),(e,t)=>{var S;const m=O("a-spin"),C=O("a-modal");return n(),d("div",na,[a("div",da,[a("div",la,[h(c(ea),{size:32})]),a("h1",null,s(e.$t("dashboard.order.title")),1),a("p",null,s(e.$t("dashboard.order.description")),1)]),!f.value&&l.value?(n(),d("div",ra,[a("div",ia,[a("div",ca,[a("div",ua,[a("h3",null,s(e.$t("dashboard.order.detailTitle")),1),a("span",_a,"#"+s(l.value.trade_no),1)]),a("div",ha,[a("div",pa,[a("div",va,[a("span",ma,s((S=l.value.plan)==null?void 0:S.name),1),a("span",ya,s(B(l.value.period)),1)]),a("div",fa,"¥"+s((l.value.total_amount/100).toFixed(2)),1)])]),l.value.coupon_id?(n(),d("div",ba,[a("div",ka,[h(c(oa),{size:16}),a("span",null,s(e.$t("dashboard.order.coupon")),1)]),a("div",ga,"-¥"+s((l.value.discount_amount/100).toFixed(2)),1)])):i("",!0),a("div",$a,[a("span",null,s(e.$t("dashboard.order.total")),1),a("span",Ca,"¥"+s((l.value.total_amount/100).toFixed(2)),1)])]),a("div",wa,[a("div",za,[a("h3",null,s(e.$t("dashboard.order.paymentTitle")),1)]),a("div",Ma,[(n(!0),d(q,null,F(k.value,o=>(n(),d("div",{key:o.id,class:G(["payment-item",{active:v.value===o.id}]),onClick:T=>v.value=o.id},[a("div",Sa,[o.icon?(n(),d("img",{key:0,src:o.icon,alt:"icon"},null,8,Ta)):(n(),I(c(sa),{key:1,size:24}))]),a("div",qa,[a("span",Fa,s(o.name),1),o.handling_fee_percent||o.handling_fee_fixed?(n(),d("span",Ia,s(e.$t("dashboard.order.fee"))+": "+s(o.handling_fee_percent?o.handling_fee_percent+"%":"")+" "+s(o.handling_fee_fixed?"¥"+(o.handling_fee_fixed/100).toFixed(2):""),1)):i("",!0)]),t[2]||(t[2]=a("div",{class:"check-mark"},[a("div",{class:"outer"},[a("div",{class:"inner"})])],-1))],10,Pa))),128))]),a("div",Oa,[a("button",{class:"pay-btn",disabled:!v.value||p.value,onClick:D},[p.value?(n(),I(c(R),{key:0,class:"animate-spin",size:20})):i("",!0),p.value?(n(),d("span",Na,s(e.$t("dashboard.order.paying")),1)):(n(),d("span",Wa,s(e.$t("dashboard.order.payNow")),1))],8,Ra),a("button",{class:"cancel-btn",onClick:j,disabled:p.value},s(e.$t("dashboard.order.cancel")),9,Ba)])])]),a("div",Da,[a("div",Va,[a("div",ja,[h(c(ta),{size:18}),a("h3",null,s(e.$t("dashboard.order.tipsTitle")),1)]),a("ul",La,[(n(!0),d(q,null,F(e.$tm("dashboard.order.tips"),(o,T)=>(n(),d("li",{key:T},s(o),1))),128))])])])])):i("",!0),f.value?(n(),d("div",Aa,[h(m,{size:"large"}),a("p",null,s(e.$t("common.loading")),1)])):i("",!0),!f.value&&!l.value?(n(),d("div",Ea,[t[3]||(t[3]=a("div",{class:"error-icon"},"⚠️",-1)),a("p",null,s(w.value||e.$t("dashboard.order.notFound")),1),a("button",{class:"back-link",onClick:t[0]||(t[0]=o=>c(b).push("/plans"))},s(e.$t("dashboard.plans.title")),1)])):i("",!0),h(C,{visible:g.value,"onUpdate:visible":t[1]||(t[1]=o=>g.value=o),footer:null,closable:!z.value,onCancel:M,centered:"",class:"pay-modal"},{default:Q(()=>{var o;return[a("div",Ua,[a("h3",null,s(e.$t("dashboard.order.scanTitle")),1),a("div",Ha,[_.value.type===1?(n(),d("div",Qa,[a("div",Ga,[h(c(J),{value:_.value.data,size:200,color:"#3b82f6"},null,8,["value"])]),(o=_.value.data)!=null&&o.startsWith("http")?(n(),d("div",Ja,[a("p",Ka,s(e.$t("dashboard.order.cannotScanTip")),1),a("a",{href:_.value.data,target:"_blank",class:"pay-link-btn"},s(e.$t("dashboard.order.goToPay")),9,Xa)])):i("",!0)])):_.value.type===0?(n(),d("div",Ya,[a("p",null,s(e.$t("dashboard.order.jumpPay")),1),a("a",{href:_.value.data,target:"_blank",class:"pay-link-btn"},s(e.$t("dashboard.order.goToPay")),9,Za)])):i("",!0)]),a("div",xa,[h(c(R),{class:"animate-spin",size:16}),a("span",null,s(e.$t("dashboard.order.waiting")),1)])])]}),_:1},8,["visible","closable"])])}}},ce=aa(ae,[["__scopeId","data-v-797b84af"]]);export{ce as default};
